{% extends "base.html" %}

{% block title %}Learn: {{ topic.title }} - Day {{ day }}{% endblock %}

{% block content %}
<div class="card">
    <!-- Header with progress -->
    <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
            <div style="flex-grow: 1; min-width: 200px;">
                <h1 style="font-size: 24px; margin-bottom: 5px; word-break: break-word;">{{ topic.title }}</h1>
                <p style="color: #718096; font-size: 14px; margin: 0;">Day {{ day }} of {{ topic.timeframe_days }}</p>
            </div>
            <div style="text-align: right; flex-shrink: 0;">
                <div style="margin-bottom: 8px;">
                    <span id="page-counter" style="color: #667eea; font-weight: bold; font-size: 14px;">1 / {{ total_pages }}</span>
                </div>
                <div class="progress-bar" style="width: 150px; height: 6px;">
                    <div id="progress-fill" class="progress-fill" style="width: {{ (100 / total_pages) }}%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation buttons -->
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; gap: 10px;">
        <button id="prev-btn" class="btn btn-secondary" onclick="previousPage()" disabled style="flex: 1; max-width: 120px;">‚Üê Prev</button>
        <button id="next-btn" class="btn" onclick="nextPage()" style="flex: 1; max-width: 120px;">Next ‚Üí</button>
    </div>
    
    <!-- Page content container -->
    <div id="page-content" style="min-height: 300px;">
        <!-- Content will be dynamically loaded here -->
    </div>
    
    <!-- Skip button for certain page types -->
    <div id="skip-section" style="text-align: center; margin-top: 15px; display: none;">
        <button class="btn btn-secondary" onclick="nextPage()" style="font-size: 14px; padding: 10px 20px;">Skip this section</button>
    </div>
    
    <!-- Answer submission for quiz questions -->
    <div id="answer-section" style="display: none; margin-top: 20px;">
        <div style="text-align: center;">
            <button id="submit-answer" class="btn" onclick="submitAnswer()" style="font-size: 16px; padding: 12px 24px;">Submit Answer</button>
        </div>
    </div>
    
    <!-- Show explanation section -->
    <div id="explanation-section" style="display: none; margin-top: 20px;">
        <div id="explanation-content" style="padding: 15px; background: #f0f4ff; border-radius: 10px; border-left: 3px solid #667eea; font-size: 14px; line-height: 1.5;">
            <!-- Explanation will be inserted here -->
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="btn" onclick="nextPage()" style="font-size: 16px; padding: 12px 24px;">Continue</button>
        </div>
    </div>
</div>

<!-- Mobile-specific styles -->
<style>
    @media (min-width: 768px) {
        .card h1 {
            font-size: 32px !important;
            margin-bottom: 8px !important;
        }
        
        .card p {
            font-size: 16px !important;
        }
        
        #page-counter {
            font-size: 16px !important;
        }
        
        .progress-bar {
            width: 200px !important;
            height: 8px !important;
        }
        
        .card > div:nth-child(2) {
            margin-bottom: 30px !important;
        }
        
        .card > div:nth-child(3) {
            margin-bottom: 30px !important;
        }
        
        #prev-btn, #next-btn {
            max-width: 140px !important;
            font-size: 16px !important;
        }
        
        #page-content {
            min-height: 400px !important;
        }
        
        #skip-section {
            margin-top: 20px !important;
        }
        
        #skip-section button {
            font-size: 16px !important;
            padding: 12px 24px !important;
        }
        
        #answer-section {
            margin-top: 30px !important;
        }
        
        #explanation-section {
            margin-top: 30px !important;
        }
        
        #explanation-content {
            padding: 20px !important;
            border-radius: 12px !important;
            border-left: 4px solid #667eea !important;
            font-size: 16px !important;
        }
        
        #explanation-section > div:nth-child(2) {
            margin-top: 20px !important;
        }
    }
    
    /* Fix for touch devices */
    @media (max-width: 767px) {
        .enhanced-flashcard {
            -webkit-tap-highlight-color: transparent;
        }
        
        .enhanced-quiz-option {
            -webkit-tap-highlight-color: transparent;
        }
        
        button {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Ensure text doesn't get too small */
        .flashcard-front, .flashcard-back {
            font-size: 16px !important;
        }
        
        /* Better touch targets */
        .enhanced-quiz-option {
            min-height: 44px !important;
            padding: 15px !important;
        }
        
        .btn {
            min-height: 44px !important;
            touch-action: manipulation;
        }
    }
</style>

<script>
// Page data passed from Flask
const pages = {{ pages | tojson }};
const topicId = {{ topic.id }};
const dayNumber = {{ day }};
let currentPageIndex = 0;
let pageStartTime = Date.now();
let userAnswers = {};

// Initialize the first page
document.addEventListener('DOMContentLoaded', function() {
    loadPage(0);
});

function loadPage(index) {
    if (index < 0 || index >= pages.length) return;
    
    currentPageIndex = index;
    const page = pages[index];
    const pageContent = document.getElementById('page-content');
    
    // Track time on previous page
    if (index > 0) {
        const timeSpent = Math.floor((Date.now() - pageStartTime) / 1000);
        trackProgress(pages[index-1].type, `page_${index-1}`, null, timeSpent);
    }
    pageStartTime = Date.now();
    
    // Update progress
    updateProgress();
    
    // Hide all sections initially
    document.getElementById('skip-section').style.display = 'none';
    document.getElementById('answer-section').style.display = 'none';
    document.getElementById('explanation-section').style.display = 'none';
    
    // Load content based on page type
    switch(page.type) {
        case 'intro':
            loadIntroPage(page);
            break;
        case 'note_title':
            loadNoteTitlePage(page);
            break;
        case 'note_content':
            loadNoteContentPage(page);
            break;
        case 'section_intro':
            loadSectionIntroPage(page);
            break;
        case 'flashcard':
            loadFlashcardPage(page);
            break;
        case 'quiz_question':
            loadQuizQuestionPage(page);
            break;
        case 'completion':
            loadCompletionPage(page);
            break;
    }
    
    // Update navigation buttons
    updateNavigationButtons();
    
    // Scroll to top
    window.scrollTo(0, 0);
}

function loadIntroPage(page) {
    document.getElementById('page-content').innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; text-align: center; padding: 40px 20px; margin: 10px 0; box-shadow: 0 15px 30px rgba(102, 126, 234, 0.3);">
            <div style="font-size: 48px; margin-bottom: 20px; animation: bounce 2s infinite;">üéØ</div>
            <h1 style="font-size: 32px; margin-bottom: 15px; font-weight: bold; text-shadow: 0 2px 10px rgba(0,0,0,0.3); line-height: 1.2;">${page.title}</h1>
            <p style="font-size: 18px; opacity: 0.9; max-width: 400px; margin: 0 auto; line-height: 1.4;">${page.content}</p>
        </div>
        <style>
            @keyframes bounce {
                0%, 20%, 60%, 100% { transform: translateY(0); }
                40% { transform: translateY(-15px); }
                80% { transform: translateY(-8px); }
            }
            @media (min-width: 768px) {
                #page-content > div {
                    padding: 80px 40px !important;
                    margin: 20px 0 !important;
                    border-radius: 20px !important;
                }
                #page-content h1 {
                    font-size: 52px !important;
                    margin-bottom: 25px !important;
                }
                #page-content p {
                    font-size: 22px !important;
                    max-width: 600px !important;
                }
                #page-content > div > div {
                    font-size: 64px !important;
                    margin-bottom: 30px !important;
                }
            }
        </style>
    `;
}

function loadNoteTitlePage(page) {
    document.getElementById('page-content').innerHTML = `
        <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 15px; margin: 10px 0;">
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 36px; font-weight: bold; margin-bottom: 20px; line-height: 1.2; word-break: break-word;">
                ${page.content}
            </div>
            <div style="width: 60px; height: 3px; background: linear-gradient(90deg, #667eea, #764ba2); margin: 0 auto; border-radius: 2px;"></div>
            <p style="font-size: 16px; color: #64748b; margin-top: 15px; font-style: italic;">Let's dive deeper into this concept</p>
        </div>
        <style>
            @media (min-width: 768px) {
                #page-content > div {
                    padding: 80px 40px !important;
                    margin: 20px 0 !important;
                    border-radius: 20px !important;
                }
                #page-content > div > div {
                    font-size: 56px !important;
                    margin-bottom: 30px !important;
                }
                #page-content p {
                    font-size: 20px !important;
                    margin-top: 25px !important;
                }
                #page-content > div > div:nth-child(2) {
                    width: 80px !important;
                    height: 4px !important;
                }
            }
        </style>
    `;
}

function loadNoteContentPage(page) {
    document.getElementById('page-content').innerHTML = `
        <div style="padding: 20px; max-width: 100%; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="color: #667eea; font-size: 24px; margin-bottom: 10px; word-break: break-word;">${page.title}</h2>
                <div style="width: 40px; height: 2px; background: linear-gradient(90deg, #667eea, #764ba2); margin: 0 auto; border-radius: 1px;"></div>
            </div>
            
            <div style="background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%); padding: 25px; border-radius: 15px; border: 1px solid #e2e8f0; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.1); position: relative; overflow: hidden;">
                <div style="position: absolute; top: -30px; right: -30px; width: 60px; height: 60px; background: linear-gradient(135deg, #667eea20, #764ba220); border-radius: 50%; opacity: 0.5;"></div>
                <div style="position: absolute; bottom: -20px; left: -20px; width: 50px; height: 50px; background: linear-gradient(135deg, #764ba220, #667eea20); border-radius: 50%; opacity: 0.5;"></div>
                
                <div style="position: relative; z-index: 1;">
                    <div style="font-size: 16px; line-height: 1.6; color: #2d3748; text-align: left;">
                        ${formatContentText(page.content)}
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <div style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #667eea10, #764ba210); border-radius: 20px; color: #667eea; font-weight: 600; font-size: 14px;">
                    üí° Take your time to understand this concept
                </div>
            </div>
        </div>
        <style>
            @media (min-width: 768px) {
                #page-content > div {
                    padding: 40px !important;
                    max-width: 800px !important;
                }
                #page-content h2 {
                    font-size: 32px !important;
                    margin-bottom: 15px !important;
                }
                #page-content > div > div:nth-child(1) {
                    margin-bottom: 40px !important;
                }
                #page-content > div > div:nth-child(1) > div:nth-child(2) {
                    width: 60px !important;
                    height: 3px !important;
                }
                #page-content > div > div:nth-child(2) {
                    padding: 40px !important;
                    border-radius: 20px !important;
                }
                #page-content > div > div:nth-child(2) > div:nth-child(1) {
                    width: 100px !important;
                    height: 100px !important;
                    top: -50px !important;
                    right: -50px !important;
                }
                #page-content > div > div:nth-child(2) > div:nth-child(2) {
                    width: 80px !important;
                    height: 80px !important;
                    bottom: -30px !important;
                    left: -30px !important;
                }
                #page-content > div > div:nth-child(2) > div:nth-child(3) > div {
                    font-size: 20px !important;
                }
                #page-content > div > div:nth-child(3) {
                    margin-top: 30px !important;
                }
                #page-content > div > div:nth-child(3) > div {
                    padding: 12px 24px !important;
                    font-size: 16px !important;
                }
            }
        </style>
    `;
}

function loadSectionIntroPage(page) {
    const icons = {
        'Practice Time!': 'üß†',
        'Quiz Time!': 'üìù',
        'Comprehensive Review': 'üéØ'
    };
    const icon = icons[page.title] || '‚ú®';
    
    document.getElementById('page-content').innerHTML = `
        <div style="background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); border-radius: 15px; color: white; text-align: center; padding: 40px 20px; margin: 10px 0; box-shadow: 0 15px 30px rgba(118, 75, 162, 0.3);">
            <div style="font-size: 56px; margin-bottom: 20px; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));">${icon}</div>
            <h1 style="font-size: 32px; margin-bottom: 15px; font-weight: bold; text-shadow: 0 2px 10px rgba(0,0,0,0.3); line-height: 1.2;">${page.title}</h1>
            <p style="font-size: 18px; opacity: 0.9; max-width: 400px; margin: 0 auto; line-height: 1.4;">${page.content}</p>
            <div style="margin-top: 20px;">
                <div style="display: inline-block; width: 40px; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px; margin: 0 3px;"></div>
                <div style="display: inline-block; width: 40px; height: 3px; background: rgba(255,255,255,0.6); border-radius: 2px; margin: 0 3px;"></div>
                <div style="display: inline-block; width: 40px; height: 3px; background: white; border-radius: 2px; margin: 0 3px;"></div>
            </div>
        </div>
        <style>
            @media (min-width: 768px) {
                #page-content > div {
                    padding: 80px 40px !important;
                    margin: 20px 0 !important;
                    border-radius: 20px !important;
                }
                #page-content > div > div:nth-child(1) {
                    font-size: 72px !important;
                    margin-bottom: 30px !important;
                }
                #page-content h1 {
                    font-size: 48px !important;
                    margin-bottom: 25px !important;
                }
                #page-content p {
                    font-size: 22px !important;
                    max-width: 600px !important;
                }
                #page-content > div > div:nth-child(4) {
                    margin-top: 30px !important;
                }
                #page-content > div > div:nth-child(4) > div {
                    width: 60px !important;
                    height: 4px !important;
                    margin: 0 5px !important;
                }
            }
        </style>
    `;
}

function loadFlashcardPage(page) {
    document.getElementById('page-content').innerHTML = `
        <div style="padding: 20px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                    üí° ${page.note_reference}
                </span>
            </div>
            
            <div class="flashcard enhanced-flashcard" onclick="flipCard(this)" style="margin: 0 auto; max-width: 100%; cursor: pointer; transition: transform 0.3s ease;">
                <div class="flashcard-inner" style="min-height: 250px;">
                    <div class="flashcard-front" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); min-height: 250px;">
                        <div style="font-size: 20px; margin-bottom: 15px; font-weight: 600; text-align: center; line-height: 1.4; word-break: break-word;">${page.front}</div>
                        <div style="margin-top: auto; opacity: 0.8; font-size: 14px; text-align: center;">
                            <div style="margin-bottom: 8px;">üëÜ Tap to reveal answer</div>
                            <div style="width: 30px; height: 2px; background: rgba(255,255,255,0.5); margin: 0 auto; border-radius: 1px;"></div>
                        </div>
                    </div>
                    <div class="flashcard-back" style="background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; box-shadow: 0 10px 25px rgba(118, 75, 162, 0.3); min-height: 250px;">
                        <div style="font-size: 18px; text-align: center; line-height: 1.5; margin-bottom: 15px; word-break: break-word;">${formatContentText(page.back)}</div>
                        <div style="margin-top: auto; opacity: 0.8; font-size: 12px; text-align: center;">
                            <div style="width: 30px; height: 2px; background: rgba(255,255,255,0.5); margin: 0 auto; border-radius: 1px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 25px;">
                <div style="display: inline-block; padding: 12px 20px; background: #f8fafc; border-radius: 20px; color: #64748b; font-size: 14px;">
                    üîÑ Tap the card to flip and see the answer
                </div>
            </div>
        </div>
        
        <style>
            .enhanced-flashcard:hover {
                transform: translateY(-3px);
            }
            .enhanced-flashcard {
                -webkit-tap-highlight-color: transparent;
            }
            @media (min-width: 768px) {
                #page-content > div {
                    padding: 40px !important;
                }
                #page-content > div > div:nth-child(1) > span {
                    padding: 10px 20px !important;
                    font-size: 14px !important;
                }
                #page-content > div > div:nth-child(1) {
                    margin-bottom: 30px !important;
                }
                .flashcard {
                    max-width: 600px !important;
                }
                .flashcard-inner {
                    min-height: 300px !important;
                }
                .flashcard-front, .flashcard-back {
                    padding: 40px !important;
                    border-radius: 20px !important;
                    min-height: 300px !important;
                }
                .flashcard-front > div:first-child {
                    font-size: 28px !important;
                    margin-bottom: 25px !important;
                }
                .flashcard-back > div:first-child {
                    font-size: 24px !important;
                    margin-bottom: 20px !important;
                }
                .flashcard-front > div:nth-child(2) {
                    font-size: 16px !important;
                    margin-bottom: 10px !important;
                }
                .flashcard-front > div:nth-child(2) > div:nth-child(2) {
                    width: 40px !important;
                    height: 3px !important;
                }
                .flashcard-back > div:nth-child(2) > div {
                    width: 40px !important;
                    height: 3px !important;
                }
                #page-content > div > div:nth-child(3) {
                    margin-top: 40px !important;
                }
                #page-content > div > div:nth-child(3) > div {
                    padding: 15px 30px !important;
                    font-size: 16px !important;
                }
            }
        </style>
    `;
    
    // Show skip option for flashcards
    document.getElementById('skip-section').style.display = 'block';
}

function loadQuizQuestionPage(page) {
    const question = page.question;
    let optionsHtml = '';
    
    if (question.type === 'multiple_choice') {
        optionsHtml = question.options.map((option, index) => `
            <label class="enhanced-quiz-option" onclick="selectOption(this, '${option.replace(/'/g, "\\'")}', '${question.correct_answer.replace(/'/g, "\\'")}')" style="display: block; margin: 12px 0; padding: 15px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 16px; position: relative; overflow: hidden;">
                <input type="radio" name="question_${currentPageIndex}" value="${option}" style="display: none;">
                <div style="position: absolute; left: 0; top: 0; width: 4px; height: 100%; background: linear-gradient(135deg, #667eea, #764ba2); transform: scaleY(0); transition: transform 0.3s ease; transform-origin: bottom;"></div>
                <div style="position: relative; z-index: 1; display: flex; align-items: center;">
                    <div style="width: 20px; height: 20px; border: 2px solid #cbd5e0; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; flex-shrink: 0;">
                        <div style="width: 10px; height: 10px; background: #667eea; border-radius: 50%; transform: scale(0); transition: transform 0.3s ease;"></div>
                    </div>
                    <span style="word-break: break-word; line-height: 1.4;">${option}</span>
                </div>
            </label>
        `).join('');
    } else {
        optionsHtml = `
            <div style="margin: 20px 0;">
                <textarea id="text-answer" class="enhanced-text-answer" data-correct="${question.correct_answer}" 
                          placeholder="Type your detailed answer here..." rows="5" 
                          style="width: 100%; padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; line-height: 1.6; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); resize: vertical; transition: all 0.3s ease; box-sizing: border-box;">
                </textarea>
            </div>
        `;
    }
    
    document.getElementById('page-content').innerHTML = `
        <div style="padding: 20px; max-width: 100%; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 18px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                    ${page.quiz_type === 'today' ? 'üìù Today\'s Quiz' : 'üéØ Comprehensive Review'}
                </span>
            </div>
            
            <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); border: 1px solid #f1f5f9;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; color: #1a202c; margin-bottom: 8px;">Question ${page.question_index + 1}</h3>
                    <div style="width: 40px; height: 2px; background: linear-gradient(90deg, #667eea, #764ba2); margin: 0 auto; border-radius: 1px;"></div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 16px; line-height: 1.6; color: #2d3748; text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px; border-left: 3px solid #667eea;">
                        ${question.question}
                    </p>
                </div>
                
                <div class="quiz-options">${optionsHtml}</div>
            </div>
        </div>
        
        <style>
            .enhanced-quiz-option:hover {
                background: linear-gradient(135deg, #f0f4ff 0%, #e6efff 100%);
                border-color: #667eea;
                transform: translateY(-1px);
                box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
            }
            
            .enhanced-quiz-option:hover > div:first-child {
                transform: scaleY(1);
            }
            
            .enhanced-quiz-option.selected {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-color: #667eea;
                color: white;
            }
            
            .enhanced-quiz-option.selected > div:first-child {
                transform: scaleY(1);
                background: rgba(255,255,255,0.3);
            }
            
            .enhanced-quiz-option.selected > div:nth-child(2) > div:first-child {
                border-color: white;
            }
            
            .enhanced-quiz-option.selected > div:nth-child(2) > div:first-child > div {
                transform: scale(1);
                background: white;
            }
            
            .enhanced-text-answer:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            
            .enhanced-quiz-option {
                -webkit-tap-highlight-color: transparent;
            }
            
            @media (min-width: 768px) {
                #page-content > div {
                    padding: 40px !important;
                    max-width: 800px !important;
                }
                #page-content > div > div:nth-child(1) {
                    margin-bottom: 30px !important;
                }
                #page-content > div > div:nth-child(1) > span {
                    padding: 12px 24px !important;
                    font-size: 16px !important;
                }
                #page-content > div > div:nth-child(2) {
                    padding: 40px !important;
                    border-radius: 20px !important;
                }
                #page-content h3 {
                    font-size: 24px !important;
                    margin-bottom: 10px !important;
                }
                #page-content > div > div:nth-child(2) > div:nth-child(1) {
                    margin-bottom: 30px !important;
                }
                #page-content > div > div:nth-child(2) > div:nth-child(1) > div {
                    width: 60px !important;
                    height: 3px !important;
                }
                #page-content > div > div:nth-child(2) > div:nth-child(2) {
                    margin-bottom: 30px !important;
                }
                #page-content > div > div:nth-child(2) > div:nth-child(2) > p {
                    font-size: 20px !important;
                    padding: 20px !important;
                    border-radius: 12px !important;
                    border-left: 4px solid #667eea !important;
                }
                .enhanced-quiz-option {
                    margin: 15px 0 !important;
                    padding: 20px !important;
                    border-radius: 15px !important;
                    font-size: 18px !important;
                }
                .enhanced-quiz-option > div:first-child {
                    width: 5px !important;
                }
                .enhanced-quiz-option > div:nth-child(2) > div:first-child {
                    width: 24px !important;
                    height: 24px !important;
                    margin-right: 15px !important;
                }
                .enhanced-quiz-option > div:nth-child(2) > div:first-child > div {
                    width: 12px !important;
                    height: 12px !important;
                }
                .enhanced-text-answer {
                    padding: 25px !important;
                    border-radius: 15px !important;
                    font-size: 18px !important;
                }
            }
        </style>
    `;
    
    document.getElementById('answer-section').style.display = 'block';
}

function loadCompletionPage(page) {
    document.getElementById('page-content').innerHTML = `
        <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); border-radius: 15px; color: white; text-align: center; padding: 40px 20px; margin: 10px 0; box-shadow: 0 15px 30px rgba(72, 187, 120, 0.3);">
            <div style="font-size: 60px; margin-bottom: 20px; animation: celebration 2s ease-in-out;">üéâ</div>
            <h1 style="font-size: 36px; margin-bottom: 15px; font-weight: bold; text-shadow: 0 2px 10px rgba(0,0,0,0.3); line-height: 1.2;">${page.title}</h1>
            <p style="font-size: 18px; opacity: 0.9; margin-bottom: 25px; max-width: 400px; margin-left: auto; margin-right: auto; line-height: 1.4;">${page.content}</p>
            
            <div style="margin: 25px 0; display: flex; flex-direction: column; gap: 10px;">
                <div style="display: inline-block; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 14px;">
                    ‚≠ê Knowledge Gained
                </div>
                <div style="display: inline-block; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 14px;">
                    üß† Skills Improved
                </div>
                <div style="display: inline-block; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 14px;">
                    üöÄ Progress Made
                </div>
            </div>
            
            <a href="/complete_day/${topicId}" style="display: inline-block; background: white; color: #38a169; padding: 15px 30px; border-radius: 40px; font-size: 16px; font-weight: bold; text-decoration: none; box-shadow: 0 8px 20px rgba(0,0,0,0.2); transition: all 0.3s ease; margin-top: 15px;">
                Complete Day & Return to Dashboard
            </a>
        </div>
        
        <style>
            @keyframes celebration {
                0% { transform: scale(0.8) rotate(0deg); }
                50% { transform: scale(1.2) rotate(180deg); }
                100% { transform: scale(1) rotate(360deg); }
            }
            
            a:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 25px rgba(0,0,0,0.3);
            }
            
            @media (min-width: 768px) {
                #page-content > div {
                    padding: 80px 40px !important;
                    margin: 20px 0 !important;
                    border-radius: 20px !important;
                }
                #page-content > div > div:nth-child(1) {
                    font-size: 80px !important;
                    margin-bottom: 30px !important;
                }
                #page-content h1 {
                    font-size: 52px !important;
                    margin-bottom: 25px !important;
                }
                #page-content p {
                    font-size: 22px !important;
                    margin-bottom: 40px !important;
                    max-width: 600px !important;
                }
                #page-content > div > div:nth-child(3) {
                    margin: 40px 0 !important;
                    flex-direction: row !important;
                    justify-content: center !important;
                    flex-wrap: wrap !important;
                }
                #page-content > div > div:nth-child(3) > div {
                    padding: 15px 30px !important;
                    margin: 0 10px !important;
                    font-size: 16px !important;
                }
                #page-content a {
                    padding: 20px 40px !important;
                    border-radius: 50px !important;
                    font-size: 20px !important;
                    margin-top: 20px !important;
                }
            }
        </style>
    `;
}

function flipCard(card) {
    card.classList.toggle('flipped');
    // Track flashcard interaction
    trackProgress('flashcard', `flashcard_${currentPageIndex}`, null, 3);
}

function selectOption(option, selectedValue, correctAnswer) {
    // Remove previous selections
    const parent = option.closest('.quiz-options');
    parent.querySelectorAll('.enhanced-quiz-option').forEach(opt => {
        opt.classList.remove('selected');
        // Reset radio button styling
        const radioCircle = opt.querySelector('div:nth-child(2) > div:first-child');
        const radioDot = radioCircle ? radioCircle.querySelector('div') : null;
        if (radioCircle) {
            radioCircle.style.borderColor = '#cbd5e0';
        }
        if (radioDot) {
            radioDot.style.background = '#667eea';
            radioDot.style.transform = 'scale(0)';
        }
        // Reset accent bar
        const accentBar = opt.querySelector('div:first-child');
        if (accentBar) {
            accentBar.style.transform = 'scaleY(0)';
        }
    });
    
    // Add selection to clicked option
    option.classList.add('selected');
    const radioCircle = option.querySelector('div:nth-child(2) > div:first-child');
    const radioDot = radioCircle ? radioCircle.querySelector('div') : null;
    const accentBar = option.querySelector('div:first-child');
    
    if (radioCircle) {
        radioCircle.style.borderColor = 'white';
    }
    if (radioDot) {
        radioDot.style.background = 'white';
        radioDot.style.transform = 'scale(1)';
    }
    if (accentBar) {
        accentBar.style.transform = 'scaleY(1)';
        accentBar.style.background = 'rgba(255,255,255,0.3)';
    }
    
    // Set the radio button
    const radioInput = option.querySelector('input');
    if (radioInput) {
        radioInput.checked = true;
    }
    
    // Store answer
    userAnswers[currentPageIndex] = {
        selected: selectedValue,
        correct: correctAnswer,
        isCorrect: selectedValue === correctAnswer
    };
}

function submitAnswer() {
    const page = pages[currentPageIndex];
    const question = page.question;
    let isCorrect = false;
    let userAnswer = '';
    
    if (question.type === 'multiple_choice') {
        const selected = document.querySelector('.enhanced-quiz-option.selected');
        if (!selected) {
            alert('Please select an answer before submitting.');
            return;
        }
        userAnswer = selected.querySelector('input').value;
        isCorrect = userAnswer === question.correct_answer;
    } else {
        const textAnswer = document.getElementById('text-answer');
        userAnswer = textAnswer.value.trim();
        if (!userAnswer) {
            alert('Please enter an answer before submitting.');
            return;
        }
        // Simple text comparison - can be improved
        isCorrect = userAnswer.toLowerCase().includes(question.correct_answer.toLowerCase());
    }
    
    // Store answer
    userAnswers[currentPageIndex] = {
        selected: userAnswer,
        correct: question.correct_answer,
        isCorrect: isCorrect
    };
    
    // Track progress
    trackProgress(page.quiz_type + '_quiz', `question_${page.question_index}`, isCorrect, 30);
    
    // Show explanation
    showExplanation(question, isCorrect);
}

function showExplanation(question, isCorrect) {
    const explanationContent = document.getElementById('explanation-content');
    const resultColor = isCorrect ? '#48bb78' : '#e53e3e';
    const resultIcon = isCorrect ? '‚úÖ' : '‚ùå';
    const resultText = isCorrect ? 'Correct!' : 'Not quite right';
    
    explanationContent.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
            <span style="font-size: 20px;">${resultIcon}</span>
            <h3 style="color: ${resultColor}; margin: 8px 0; font-size: 18px;">${resultText}</h3>
        </div>
        <p style="margin-bottom: 12px; font-size: 14px;"><strong>Correct Answer:</strong> ${question.correct_answer}</p>
        <p style="font-size: 14px;"><strong>Explanation:</strong> ${question.explanation}</p>
    `;
    
    // Hide answer section and show explanation
    document.getElementById('answer-section').style.display = 'none';
    document.getElementById('explanation-section').style.display = 'block';
}

function nextPage() {
    if (currentPageIndex < pages.length - 1) {
        loadPage(currentPageIndex + 1);
    }
}

function previousPage() {
    if (currentPageIndex > 0) {
        loadPage(currentPageIndex - 1);
    }
}

function updateProgress() {
    const progress = ((currentPageIndex + 1) / pages.length) * 100;
    document.getElementById('progress-fill').style.width = progress + '%';
    document.getElementById('page-counter').textContent = `${currentPageIndex + 1} / ${pages.length}`;
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    prevBtn.disabled = currentPageIndex === 0;
    prevBtn.style.opacity = currentPageIndex === 0 ? '0.5' : '1';
    
    if (currentPageIndex === pages.length - 1) {
        nextBtn.style.display = 'none';
    } else {
        nextBtn.style.display = 'inline-block';
        
        // For quiz questions, hide next button until answered
        const page = pages[currentPageIndex];
        if (page.type === 'quiz_question') {
            nextBtn.style.display = 'none';
        }
    }
}

async function trackProgress(contentType, questionId, isCorrect, timeSpent) {
    try {
        await fetch('/track_progress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic_id: topicId,
                day_number: dayNumber,
                content_type: contentType,
                question_id: questionId,
                is_correct: isCorrect,
                time_spent: timeSpent
            })
        });
    } catch (error) {
        console.error('Error tracking progress:', error);
    }
}

// Keyboard navigation (only on larger screens)
document.addEventListener('keydown', function(e) {
    if (window.innerWidth >= 768) {
        if (e.key === 'ArrowLeft' && !document.getElementById('prev-btn').disabled) {
            previousPage();
        } else if (e.key === 'ArrowRight' && document.getElementById('next-btn').style.display !== 'none') {
            nextPage();
        }
    }
});

// Touch gesture support for mobile
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const swipeDistance = touchEndX - touchStartX;
    
    if (Math.abs(swipeDistance) > swipeThreshold) {
        if (swipeDistance > 0 && !document.getElementById('prev-btn').disabled) {
            // Swipe right - go to previous page
            previousPage();
        } else if (swipeDistance < 0 && document.getElementById('next-btn').style.display !== 'none') {
            // Swipe left - go to next page
            nextPage();
        }
    }
}

// Prevent zoom on double tap for iOS
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, false);

function formatContentText(text) {
    // Enhanced text formatting
    return text
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #667eea;">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em style="color: #764ba2;">$1</em>')
        .replace(/`(.*?)`/g, '<code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #e53e3e;">$1</code>');
}
</script>
{% endblock %}